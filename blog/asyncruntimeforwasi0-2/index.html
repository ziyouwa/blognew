<!doctype html><html lang=zh-Hans><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://blog.windeye.top name=base><title>æè¾¹å¤§å”çš„åšå®¢ â€¢ WASI 0.2 å¼‚æ­¥è¿è¡Œæ—¶çš„è®¾è®¡æ€è·¯</title><link href=https://blog.windeye.top/img/seedling.png rel=icon type=image/png><link href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 105 55"><text y=".7em" font-size="82">ğŸ¦Š</text></svg>' rel=icon><link href=https://blog.windeye.top/atom.xml rel=alternate title=æè¾¹å¤§å”çš„åšå®¢ type=application/atom+xml><link href="https://blog.windeye.top/custom_subset.css?h=6de30382822eb2c02ee0" rel=stylesheet><link href="https://blog.windeye.top/main.css?h=03882d7b0d0cfe74b15f" rel=stylesheet><link href="https://blog.windeye.top/skins/zyw.css?h=4bbeae109422ff1bdcf0" rel=stylesheet><meta content="light dark" name=color-scheme><meta media="(prefers-color-scheme: light)" content=#ffffff name=theme-color><meta media="(prefers-color-scheme: dark)" content=#000000 name=theme-color><meta content="åšä¸»æ›¾æ˜¯ async-std çš„ä½œè€…ä¹‹ä¸€ï¼Œæœ‰ä¸°å¯Œçš„ç¼–å†™å¼‚æ­¥è¿è¡Œæ—¶çš„ç»éªŒï¼Œæœ¬æ–‡è®°å½•äº†ä»–ä¸º WASI 0.2 è®¾è®¡å¼‚æ­¥è¿è¡Œæ—¶çš„æ€è·¯" name=description><meta content="åšä¸»æ›¾æ˜¯ async-std çš„ä½œè€…ä¹‹ä¸€ï¼Œæœ‰ä¸°å¯Œçš„ç¼–å†™å¼‚æ­¥è¿è¡Œæ—¶çš„ç»éªŒï¼Œæœ¬æ–‡è®°å½•äº†ä»–ä¸º WASI 0.2 è®¾è®¡å¼‚æ­¥è¿è¡Œæ—¶çš„æ€è·¯" property=og:description><meta content="index, nofollow" name=robots><meta content="WASI 0.2 å¼‚æ­¥è¿è¡Œæ—¶çš„è®¾è®¡æ€è·¯" property=og:title><meta content=article property=og:type><meta content=zh_CN property=og:locale><meta content=https://blog.windeye.top/blog/asyncruntimeforwasi0-2/ property=og:url><meta content=æè¾¹å¤§å”çš„åšå®¢ property=og:site_name><meta content="default-src 'self';font-src 'self' data:;img-src 'self' https://* data:;media-src 'self' https://cdn.jsdelivr.net/;style-src 'self' https://giscus.app/default.css;frame-src player.vimeo.com https://www.youtube-nocookie.com giscus.app;connect-src 'self';script-src 'self'  giscus.app 'self'" http-equiv=Content-Security-Policy><noscript><link href=https://blog.windeye.top/no_js.css rel=stylesheet></noscript><script src=https://blog.windeye.top/js/initializeTheme.min.js></script><script defer src=https://blog.windeye.top/js/themeSwitcher.min.js></script><body><header><nav class=navbar><div class=nav-title><a class=home-title href=https://blog.windeye.top>æè¾¹å¤§å”çš„åšå®¢</a></div><div class=nav-navs><ul><li><a class="nav-links no-hover-padding" href=https://blog.windeye.top/blog/> åšå®¢ </a><li><a class="nav-links no-hover-padding" href=https://blog.windeye.top/archive/> å½’æ¡£ </a><li><a class="nav-links no-hover-padding" href=https://blog.windeye.top/tags/> æ ‡ç­¾ </a><li class="theme-switcher-wrapper js"><div aria-label=åˆ‡æ¢åˆ°æš—æ¨¡å¼ aria-pressed=false class=theme-switcher role=button tabindex=0 title=åˆ‡æ¢åˆ°æš—/äº®æ¨¡å¼></div><div aria-hidden=true aria-label=å°†æ¨¡å¼é‡ç½®ä¸ºç½‘ç«™é»˜è®¤å€¼ class=theme-resetter role=button tabindex=0 title=å°†æ¨¡å¼é‡ç½®ä¸ºç½‘ç«™é»˜è®¤å€¼></div></ul></div></nav></header><div class=content><main><article><h1 class=article-title>WASI 0.2 å¼‚æ­¥è¿è¡Œæ—¶çš„è®¾è®¡æ€è·¯</h1><ul class=meta><li>2024å¹´ 3æœˆ1æ—¥</li> â€¢ <li title="å…± 4315 å­—">è¯»å®Œçº¦éœ€ 22 åˆ†é’Ÿ</li> â€¢Â <li>æ ‡ç­¾:Â <li><a href=https://blog.windeye.top/tags/rust/>rust</a>,Â <li><a href=https://blog.windeye.top/tags/async/>async</a></ul><ul class="meta last-updated"><li>æœ€åæ›´æ–°äº 2024å¹´ 3æœˆ4æ—¥</ul><section class=body><p><a href=https://blog.yoshuawuyts.com/building-an-async-runtime-for-wasi/#blocking-until-events-are-ready>åŸæ–‡é“¾æ¥</a><p>åœ¨ 2019 å¹´ï¼Œæˆ‘å’Œ Stjepan Glavina ä¸€èµ·å¼€å‘äº† <a href=https://docs.rs/async-std><code>async-std</code> è¿è¡Œæ—¶</a>ã€‚å®ƒæ˜¯ <a href=https://docs.rs/runtime><code>runtime</code> é¡¹ç›®</a>çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œå…¶æœ¬èº«æ—¨åœ¨ç®€åŒ–åœ¨ä¸åŒå¼‚æ­¥è¿è¡Œæ—¶ä¹‹é—´è¿›è¡ŒæŠ½è±¡çš„è¿‡ç¨‹ã€‚åœ¨ <code>async-std</code> çš„å¼€å‘å·¥ä½œä¸­ï¼Œæˆ‘æœ€è‡ªè±ªçš„æ˜¯å®ç°äº†æ ¸å¿ƒ IO æŠ½è±¡ï¼Œåæ¥ Stjepan å°†å…¶å¼•å…¥ <a href=https://docs.rs/smol><code>smol</code> é¡¹ç›®</a>ï¼Œåˆ†è§£ä¸º <a href=https://docs.rs/polling><code>polling</code></a> å’Œ <a href=https://github.com/smol-rs/async-io><code>async-io</code></a> åº“ã€‚ä»–å°†å®ƒä»¬å‘å±•æˆäº†å¯ä»¥ç‹¬ç«‹å·¥ä½œçš„å¼ºå¤§æ„å»ºæ¨¡å—ï¼Œè¶…è¶Šäº†æˆ‘æœ€åˆçš„åŸå‹ä»£ç ã€‚<p>æ— è®ºå¦‚ä½•ï¼Œå›å¿†è¿™æ®µå¾€äº‹æœ‰æˆ‘çš„ç›®çš„ï¼šæˆ‘åˆšåˆšå®Œæˆäº†<a href=https://docs.rs/wasi-async-runtime/latest/wasi_async_runtime/><strong>å¦ä¸€ä¸ªå¼‚æ­¥è¿è¡Œæ—¶çš„æ„å»º</strong></a>ï¼Œæˆ‘ä¸æ˜¯è¦äººä»¬å»ä½¿ç”¨è¿™ä¸ªè¿è¡Œæ—¶ï¼Œè€Œæ˜¯å¸Œæœ›å®ƒæˆä¸ºä¸€ä¸ªå¯è¡Œçš„ã€æœ€å°çš„ã€æ­£ç¡®çš„ <a href=https://bytecodealliance.org/articles/WASI-0.2>WASI 0.2</a> å¼‚æ­¥è¿è¡Œæ—¶å®ç°ã€‚æœ¬æ–‡è¯¦ç»†ä»‹ç»æˆ‘æ˜¯å¦‚ä½•æ„å»ºå®ƒçš„ï¼Œä»¥ä¾¿æ‚¨åœ¨éœ€è¦æ—¶å¯ä»¥æ„å»ºè‡ªå·±çš„è¿è¡Œæ—¶ï¼ˆ å¦‚æœæ‚¨æœ‰è¿™ä¸ªæ‰“ç®—çš„è¯ ï¼‰ã€‚æˆ‘æ˜¯ç¬¬ä¸€ä¸ªç¼–å†™è¿™äº›ä»£ç çš„äººä¹‹ä¸€ï¼Œç”šè‡³å¯èƒ½æ˜¯ç¬¬ä¸€ä¸ªç¼–å†™ä¸“ç”¨è¿è¡Œæ—¶çš„äººã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœ <a href=https://docs.rs/smol/latest/smol/><code>Smol</code></a>ã€<a href=https://docs.rs/monoio/latest/monoio/><code>Monoio</code></a>ã€<a href=https://docs.rs/glommio/latest/glommio/><code>Glommio</code></a> æˆ– <a href=https://docs.rs/tokio/latest/tokio/><code>Tokio</code></a> æƒ³è¦æ·»åŠ å¯¹ WASI 0.2 çš„æ”¯æŒï¼Œä¹Ÿå¿…é¡»å®ç°æˆ‘å·²ç»å®ç°çš„å†…å®¹ã€‚å› æ­¤ï¼Œæˆ‘æƒ³æˆ‘å¯ä»¥å¸®åŠ©å¤§å®¶çœå»ä¸€äº›éº»çƒ¦ï¼ŒåŒæ—¶è®°å½•ä¸€ä¸‹æˆ‘åˆšåˆšå®Œæˆçš„å·¥ä½œã€‚<h2 id=wasi-0-2-lun-xun-mo-xing><a aria-label="Anchor link for: wasi-0-2-lun-xun-mo-xing" class="header-anchor no-hover-padding" href=#wasi-0-2-lun-xun-mo-xing><span aria-hidden=true class=link-icon></span></a> WASI 0.2 è½®è¯¢æ¨¡å‹</h2><p>WASI 0.2 æ˜¯åŸºäº <strong>å°±ç»ªçŠ¶æ€</strong> è€Œéå®ŒæˆçŠ¶æ€çš„ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬éœ€è¦ç­‰å¾…ä¸»æœºç³»ç»Ÿå‘Šè¯‰æˆ‘ä»¬å¯ä»¥é‡‡å–æŸç§è¡ŒåŠ¨ï¼Œè€Œä¸æ˜¯å‘Šè¯‰æˆ‘ä»¬æŸä¸ªæ“ä½œå·²æˆåŠŸå®Œæˆï¼ˆåŸºäºå®ŒæˆçŠ¶æ€ï¼‰ã€‚WASI 0.3 å¯èƒ½ä¼šåˆ‡æ¢åˆ°åŸºäºå®ŒæˆçŠ¶æ€çš„ç³»ç»Ÿï¼Œå› ä¸º <a href=https://en.wikipedia.org/wiki/Io_uring>Linux çš„ io_uring</a> å’Œ <a href=https://learn.microsoft.com/en-us/windows/win32/api/ioringapi/>Windows çš„ ioringapi</a> éƒ½æ˜¯åŸºäºå®ŒæˆçŠ¶æ€çš„ï¼Œå¹¶ä¸”æ€§èƒ½è¡¨ç°éå¸¸å‡ºè‰²ï¼Œä½†æˆ‘ä»¬è¿˜æ²¡æœ‰è¿™æ ·çš„å®ç°ã€‚<p>WASI çš„æ ¸å¿ƒè½®è¯¢ç³»ç»Ÿç”±ä¸¤ä¸ªç»„ä»¶ç»„æˆï¼š<a href=https://docs.rs/wasi/latest/wasi/io/poll/struct.Pollable.html>Pollable ç±»å‹</a>å’Œ <a href=https://docs.rs/wasi/latest/wasi/io/poll/fn.poll.html>poll æ–¹æ³•</a>ã€‚Pollable ç±»å‹è¡¨ç¤ºå¯¹æŸäº‹ä»¶çš„å…³æ³¨ã€‚å¦‚æœæˆ‘ä»¬æœ‰æŸç§è¯»å–è°ƒç”¨ï¼Œå°±ä¼šæœ‰ä¸€ä¸ªä¸è¯¥è°ƒç”¨ç›¸å…³è”çš„ Pollable ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ƒæäº¤ç»™ä¸»æœºç³»ç»Ÿï¼Œè¡¨ç¤ºï¼šâ€œè¯·åœ¨æˆ‘å¯ä»¥è°ƒç”¨è¯¥è¯»å–æ“ä½œæ—¶é€šçŸ¥æˆ‘â€ï¼Œè¿™å°±æ˜¯ç³»ç»Ÿçš„â€œå°±ç»ªâ€â€”â€”æ‚¨å°†æŸæ“ä½œçš„å…³æ³¨æäº¤ç»™ä¸»æœºç³»ç»Ÿï¼Œç„¶åä¸»æœºç³»ç»Ÿä¼šå®šæœŸäº§ç”Ÿä¸€ä¸ªåˆ—è¡¨ï¼Œåˆ—å‡ºäº†å“ªäº›æ“ä½œå¯ä»¥è°ƒç”¨ã€‚ä¸»æœºç³»ç»Ÿé€šè¿‡ poll å‡½æ•°æ¥è°ƒåº¦è¿™ç§å…³æ³¨ã€‚<p>WASI 0.2 çš„è½®è¯¢æ¨¡å‹å’Œ epoll ä¹‹é—´çš„å…³é”®åŒºåˆ«åœ¨äºï¼šåœ¨ WASI ä¸­ï¼Œæˆ‘ä»¬è°ƒåº¦çš„ä¸æ˜¯å¯¹èµ„æºï¼ˆä¾‹å¦‚æ–‡ä»¶æè¿°ç¬¦ï¼‰çš„å…³æ³¨ï¼Œè€Œæ˜¯å¯¹å…·ä½“æ“ä½œçš„å…³æ³¨ã€‚åœ¨ epoll ä¸‹ï¼Œæˆ‘ä»¬ä¼šå‘Šè¯‰å†…æ ¸ç±»ä¼¼äºï¼šâ€œå˜¿ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªä»£è¡¨æŸä¸ªå¥—æ¥å­—çš„æ–‡ä»¶æè¿°ç¬¦ - ä»»ä½•æ—¶å€™åªè¦å®ƒå¯ä»¥è¯»å–æˆ–å†™å…¥æ–°æ•°æ®æˆ‘éƒ½æ„Ÿå…´è¶£ã€‚â€ åœ¨ WASI ä¸­ï¼Œæˆ‘ä»¬æ›´åŠ ç²¾ç¡®ï¼›æˆ‘ä»¬ç”Ÿæˆä¸€ä¸ªç‰¹æ®Šçš„æ–¹æ³•ï¼Œå®ƒè¿”å›ä¸€ä¸ªç±»å‹ï¼šè¯¥ç±»å‹æœ‰è·å–åº•å±‚æ•°æ®çš„èƒ½åŠ›ï¼Œå®ƒçš„è®¢é˜…æ–¹æ³•å°†è¿”å›ä¸€ä¸ª Pollable ç±»å‹ã€‚ç„¶åç­‰ poll æ–¹æ³•å‘Šè¯‰æˆ‘ä»¬ Pollable å·²å‡†å¤‡å°±ç»ªæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨è¯¥æ–¹æ³•æ¥è·å–åº•å±‚æ•°æ®ï¼Œè€Œä¸ä¼šè¿”å›é”™è¯¯ã€‚è¯´äº†è¿™ä¹ˆå¤šï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªåŸºæœ¬ç¤ºä¾‹ï¼š<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">wasi<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">http<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">outgoing_handler<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>handle<span class="z-punctuation z-separator z-rust">,</span> OutgoingRequest</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">wasi<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">http<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">types<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>Fields<span class="z-punctuation z-separator z-rust">,</span> Method<span class="z-punctuation z-separator z-rust">,</span> Scheme</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">wasi<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">io<span class="z-punctuation z-accessor z-rust">::</span></span>poll<span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">main</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Construct an HTTP request
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> fields <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">Fields<span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> req <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">OutgoingRequest<span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>fields</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    req<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">set_method</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-meta z-path z-rust">Method<span class="z-punctuation z-accessor z-rust">::</span></span>Get</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">unwrap</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    req<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">set_scheme</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-support z-type z-rust">Some</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-meta z-path z-rust">Scheme<span class="z-punctuation z-accessor z-rust">::</span></span>Https</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">unwrap</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    req<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">set_path_with_query</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-support z-type z-rust">Some</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>/<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">unwrap</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    req<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">set_authority</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-support z-type z-rust">Some</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>example.com<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">unwrap</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Send the request and wait for it to complete
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> res <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-function z-rust">handle</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>req<span class="z-punctuation z-separator z-rust">,</span> <span class="z-support z-type z-rust">None</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">unwrap</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>  <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> 1. We're ready to send the request over the network
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> pollable <span class="z-keyword z-operator z-assignment z-rust">=</span> res<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">subscribe</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> 2. We obtain the `Pollable` from the response future
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-meta z-path z-rust">poll<span class="z-punctuation z-accessor z-rust">::</span></span>poll<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-keyword z-operator z-bitwise z-rust">&</span>pollable<span class="z-punctuation z-section z-group z-end z-rust">]</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>              <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> 3. Block until we're ready to look at the response
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> We're now ready to try and access the response headers. If
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> the request was unsuccessful we might still get an error here,
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> but we won't get an error that we tried to read data before the
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> operation was completed.
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> res <span class="z-keyword z-operator z-assignment z-rust">=</span> res<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">get</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">unwrap</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">unwrap</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">unwrap</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-keyword z-control z-rust">for</span> <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>name<span class="z-punctuation z-separator z-rust">,</span> <span class="z-keyword z-operator z-rust">_</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">in</span> res<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">headers</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">entries</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-support z-macro z-rust">println!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>header: <span class="z-constant z-other z-placeholder z-rust">{name}</span><span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>å½“æ‰§è¡Œ <a href=https://github.com/bytecodealliance/cargo-component>cargo-component</a> (ä¼ å…¥ â€“ -S httpæ ‡è®°)æ—¶ï¼Œç»“æœå¦‚ä¸‹ï¼š<pre class="language-sh z-code" data-lang=sh><code class=language-sh data-lang=sh><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">header:</span></span><span class="z-meta z-function-call z-arguments z-shell"> age</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">header:</span></span><span class="z-meta z-function-call z-arguments z-shell"> cache-control</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">header:</span></span><span class="z-meta z-function-call z-arguments z-shell"> content-type</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">header:</span></span><span class="z-meta z-function-call z-arguments z-shell"> date</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">header:</span></span><span class="z-meta z-function-call z-arguments z-shell"> etag</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">header:</span></span><span class="z-meta z-function-call z-arguments z-shell"> expires</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">header:</span></span><span class="z-meta z-function-call z-arguments z-shell"> last-modified</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">header:</span></span><span class="z-meta z-function-call z-arguments z-shell"> server</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">header:</span></span><span class="z-meta z-function-call z-arguments z-shell"> vary</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">header:</span></span><span class="z-meta z-function-call z-arguments z-shell"> x-cache</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">header:</span></span><span class="z-meta z-function-call z-arguments z-shell"> content-length</span>
</span></code></pre><h2 id=lun-xun-qi-she-ji><a aria-label="Anchor link for: lun-xun-qi-she-ji" class="header-anchor no-hover-padding" href=#lun-xun-qi-she-ji><span aria-hidden=true class=link-icon></span></a> è½®è¯¢å™¨è®¾è®¡</h2><p>HTTP è¯·æ±‚ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å±•ç¤ºäº†å¦‚ä½•å‘èµ·ä¸€ä¸ª HTTP è¯·æ±‚å¹¶å°†è¯¥æ“ä½œæ³¨å†Œåˆ° poll æ–¹æ³•ä¸­ã€‚å¼‚æ­¥è®¡ç®—çš„ä¸€ä¸ªä¸»è¦ä¼˜åŠ¿æ˜¯èƒ½å¤Ÿæ‰§è¡Œ<a href=https://blog.yoshuawuyts.com/why-async-rust/#ad-hoc-concurrency>ä¸´æ—¶å¹¶å‘</a>ï¼šæˆ‘ä»¬ä¸ä»…ä»…å¸Œæœ›èƒ½å¤Ÿç­‰å¾…æŸä¸ªæ“ä½œå®Œæˆï¼Œè¿˜å¸Œæœ›èƒ½å¤ŸåŒæ—¶ç­‰å¾…ä»»æ„æ•°é‡çš„æ“ä½œå®Œæˆã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ poll æ–¹æ³•æ¥å—ä¸€ä¸ª Pollable ç±»å‹çš„åˆ—è¡¨ä½œä¸ºå‚æ•°ï¼Œå¹¶ä¸”è¿”å›çš„ä¹Ÿæ˜¯ä¸€ä¸ªå·²å‡†å¤‡å¥½ç»§ç»­æ‰§è¡Œæ“ä½œçš„åˆ—è¡¨ã€‚<p>ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ç§ç±»å‹æ¥ä¿å­˜ Pollableï¼Œå®ƒçš„æ“ä½œè¦é«˜æ•ˆï¼Œå¹¶å…è®¸æˆ‘ä»¬å°†â€œå°±ç»ªâ€äº‹ä»¶åˆ—è¡¨ä¸æŸç§èº«ä»½æ¦‚å¿µå…³è”èµ·æ¥ã€‚è¿™å¾ˆé‡è¦ï¼Œå› ä¸ºæˆ‘ä»¬æ­£åœ¨æ„å»ºå¼‚æ­¥ Rust è¿è¡Œæ—¶ï¼Œéœ€è¦å°†â€œå°±ç»ªäº‹ä»¶â€ä¸â€œå”¤é†’ç‰¹å®šçš„<a href=https://doc.rust-lang.org/std/task/struct.Waker.html>å”¤é†’å™¨</a>â€å…³è”èµ·æ¥ã€‚æˆ‘ä»¬å¯ä»¥ä»å®šä¹‰ä¸€ä¸ªåŒ…å« <a href=https://docs.rs/slab/latest/slab/>Slab</a> çš„ç»“æ„ä½“å¼€å§‹ã€‚slab æ˜¯ä¸€ç§é«˜æ•ˆçš„é”®å€¼æ•°æ®ç»“æ„ï¼Œå®ƒåœ¨è¾“å…¥æ—¶ä¼šä¸ºæ‚¨æä¾›ä¸€ä¸ªè®¿é—®å€¼çš„é”®ã€‚å®ƒæ˜¯æ— åºä¸”åˆ†é…å¯é‡ç”¨çš„ - è¿™éå¸¸å¥½ï¼Œå› ä¸ºæˆ‘ä»¬å°†åœ¨ä¸åŒçš„ Pollable ä¸­ä¸æ–­æ³¨å†Œå’Œæ³¨é”€â€å…³æ³¨â€œã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-storage z-modifier z-rust">pub</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-other z-rust">crate</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-struct z-rust"><span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-entity z-name z-struct z-rust">Poller</span> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-modifier z-rust">pub</span><span class="z-punctuation z-definition z-modifier-scope z-begin z-rust">(</span><span class="z-storage z-modifier z-rust">crate</span><span class="z-punctuation z-definition z-modifier-scope z-end z-rust">)</span> <span class="z-variable z-other z-member z-rust">targets</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-meta z-generic z-rust">Slab<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>Pollable<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span>,
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>æ’å…¥ä¸€ä¸ªç±»å‹åˆ° Slab æ—¶ï¼Œå®ƒè¿”å›ä¸€ä¸ª usize ç±»å‹çš„é”®ã€‚ä¸ºäº†ç®€ä¾¿ï¼Œä¹Ÿä¸ºäº†èƒ½æ›´å®¹æ˜“æ¡¥æ¥åˆ° WASIï¼Œæˆ‘ä»¬å°†å®šä¹‰ EventKey ç±»å‹æ¥åŒ…è£…è¿™ä¸ªé”®ï¼Œ<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> A key representing an entry into the poller
</span></span><span class="z-source z-rust"><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">repr</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">transparent</span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
</span><span class="z-source z-rust"><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">derive</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">Debug<span class="z-punctuation z-separator z-rust">,</span> PartialEq<span class="z-punctuation z-separator z-rust">,</span> Eq<span class="z-punctuation z-separator z-rust">,</span> PartialOrd<span class="z-punctuation z-separator z-rust">,</span> Ord<span class="z-punctuation z-separator z-rust">,</span> Hash<span class="z-punctuation z-separator z-rust">,</span> Clone<span class="z-punctuation z-separator z-rust">,</span> Copy</span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
</span><span class="z-source z-rust"><span class="z-storage z-modifier z-rust">pub</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-other z-rust">crate</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-struct z-rust"><span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-entity z-name z-struct z-rust">EventKey</span></span><span class="z-meta z-struct z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>pub<span class="z-punctuation z-section z-group z-begin z-rust">(</span>crate</span><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-storage z-type z-rust">u32</span>)<span class="z-punctuation z-terminator z-rust">;</span>
</span></code></pre><p>ç°åœ¨ï¼Œæˆ‘ä»¬å·²å‡†å¤‡å¥½åœ¨è½®è¯¢å™¨ä¸Šå®ç°åŸºæœ¬ CRUD æ–¹æ³•ï¼šnewã€insertã€remove å’Œ getã€‚é™¤äº†å¯¹ EventKey çš„è½¬æ¢ä¹‹å¤–ï¼Œè¿™é‡Œæ²¡æœ‰ä»€ä¹ˆæœ‰è¶£çš„äº‹æƒ…å‘ç”Ÿã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span> </span><span class="z-meta z-impl z-rust"><span class="z-entity z-name z-impl z-rust">Poller</span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> Create a new instance of `Poller`
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-modifier z-rust">pub</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-other z-rust">crate</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">new</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> <span class="z-storage z-type z-rust">Self</span></span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-storage z-type z-rust">Self</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            targets<span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust">Slab<span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> Insert a new `Pollable` target into `Poller`
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-modifier z-rust">pub</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-other z-rust">crate</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">insert</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-parameter z-rust">self</span>, <span class="z-variable z-parameter z-rust">target</span><span class="z-punctuation z-separator z-rust">:</span> Pollable</span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> EventKey</span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-storage z-type z-rust">let</span> key <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>targets<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">insert</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>target</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        EventKey<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>key <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">u32</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> Get a `Pollable` if it exists.
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-modifier z-rust">pub</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-other z-rust">crate</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">get</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&</span><span class="z-variable z-parameter z-rust">self</span>, <span class="z-variable z-parameter z-rust">key</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&</span>EventKey</span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Option</span><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-keyword z-operator z-rust">&</span>Pollable<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>targets<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">get</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>key<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-constant z-numeric z-integer z-decimal z-rust">0</span> <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">usize</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> Remove an instance of `Pollable` from `Poller`.
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> Returns `None` if no entry was found for `key`.
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-modifier z-rust">pub</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-other z-rust">crate</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">remove</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-parameter z-rust">self</span>, <span class="z-variable z-parameter z-rust">key</span><span class="z-punctuation z-separator z-rust">:</span> EventKey</span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Option</span><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>Pollable<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>targets<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">try_remove</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>key<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-constant z-numeric z-integer z-decimal z-rust">0</span> <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">usize</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>æœ€åï¼Œæˆ‘ä»¬å®ç°æœ€æœ‰è¶£çš„éƒ¨åˆ†ï¼šåœ¨ Poller ä¸­ç­‰å¾…äº‹ä»¶çš„æ–¹æ³•ï¼Œå¹¶å°†å…¶æ˜ å°„åˆ°å®ƒä»¬å„è‡ªçš„ EventKey ä¸Šã€‚å½“æˆ‘ä»¬å‘ poll è°ƒç”¨æäº¤ Pollable åˆ—è¡¨æ—¶ï¼Œä¼šå¾—åˆ°ä¸€ä¸ªç´¢å¼•åˆ—è¡¨ï¼Œå®ƒæŒ‡å‘æˆ‘ä»¬æäº¤çš„ pollable åˆ—è¡¨çš„ç´¢å¼•ã€‚è¿™äº›å€¼ä¸æˆ‘ä»¬æ‹¥æœ‰çš„EventKeyä¸åŒï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»æ„å»ºä¸€ä¸ªæŸ¥æ‰¾è¡¨æ¥å°† Pollable åˆ—è¡¨çš„ç´¢å¼•æ˜ å°„å›äº‹ä»¶é”®ã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span> </span><span class="z-meta z-impl z-rust"><span class="z-entity z-name z-impl z-rust">Poller</span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> Block the current thread until a new event has triggered.
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> This will clear the value of `ready_list`.
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-modifier z-rust">pub</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-other z-rust">crate</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">block_until</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-parameter z-rust">self</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Vec</span><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>EventKey<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> We're about to wait for a number of pollables. When they wake we get
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> the *indexes* back for the pollables whose events were available - so
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> we need to be able to associate the index with the right waker.
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> We start by iterating over the pollables, and keeping note of which
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> pollable belongs to which waker index
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> indexes <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-type z-rust">Vec</span><span class="z-meta z-path z-rust"><span class="z-punctuation z-accessor z-rust">::</span></span>with_capacity<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>targets<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">len</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> targets <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-type z-rust">Vec</span><span class="z-meta z-path z-rust"><span class="z-punctuation z-accessor z-rust">::</span></span>with_capacity<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>targets<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">len</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-keyword z-control z-rust">for</span> <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>index<span class="z-punctuation z-separator z-rust">,</span> target</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">in</span> <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>targets<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">iter</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            indexes<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>index</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            targets<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>target</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Now that we have that association, we're ready to poll our targets.
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> This will block until an event has completed.
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-storage z-type z-rust">let</span> ready_indexes <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-function z-rust">poll</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&</span>targets</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Once we have the indexes for which pollables are available, we need
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> to convert it back to the right keys for the wakers. Earlier we
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> established a positional index -> waker key relationship, so we can
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> go right ahead and perform a lookup there.
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        ready_indexes
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">            <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">into_iter</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">            <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">map</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">|</span></span></span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-variable z-parameter z-rust">index</span><span class="z-punctuation z-section z-parameters z-end z-rust">|</span></span> </span><span class="z-meta z-function z-closure z-rust">EventKey<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>indexes<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span>index <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">usize</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span> <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">u32</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">            <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">collect</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>æˆ‘ä»¬çš„ Pollable æŠ½è±¡å°±ç®—å®Œæˆäº†ï¼<h2 id=fan-ying-qi-she-ji><a aria-label="Anchor link for: fan-ying-qi-she-ji" class="header-anchor no-hover-padding" href=#fan-ying-qi-she-ji><span aria-hidden=true class=link-icon></span></a> ååº”å™¨è®¾è®¡</h2><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥è·Ÿè¸ª Pollable åˆ—è¡¨å’Œè®¢é˜…å®ƒä»¬çš„æ–¹æ³•äº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†æŠŠå”¤é†’å™¨ï¼ˆwakersï¼‰çº³å…¥å…¶ä¸­å¹¶åˆ›å»ºä¸€ä¸ªç±»å‹ï¼Œä¾› Future ç”¨äºæ³¨å†Œå¯¹äº‹ä»¶çš„å…³æ³¨ã€‚WASI å¼‚æ­¥è¿è¡Œæ—¶æœ¬è´¨ä¸Šæ˜¯å•çº¿ç¨‹çš„ï¼Œå› æ­¤æˆ‘ä»¬å°†åœ¨è¿™é‡Œä½¿ç”¨Rcå’ŒRefCellç±»å‹ã€‚ç°åœ¨æˆ‘ä»¬å¯ä»¥æ„å»ºæ•°æ®ç±»å‹ï¼›å†æ¬¡ä»æ ¸å¿ƒç»“æ„å¼€å§‹ï¼š<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust"><span class="z-keyword z-other z-rust">super</span><span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">polling<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>EventKey<span class="z-punctuation z-separator z-rust">,</span> Poller</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">std<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">collections<span class="z-punctuation z-accessor z-rust">::</span></span>HashMap<span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">std<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">task<span class="z-punctuation z-accessor z-rust">::</span></span>Poll<span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">std<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">task<span class="z-punctuation z-accessor z-rust">::</span></span>Waker<span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">std<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span><span class="z-meta z-path z-rust">cell<span class="z-punctuation z-accessor z-rust">::</span></span>RefCell<span class="z-punctuation z-separator z-rust">,</span> <span class="z-meta z-path z-rust">rc<span class="z-punctuation z-accessor z-rust">::</span></span>Rc</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">wasi<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">io<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">poll<span class="z-punctuation z-accessor z-rust">::</span></span>Pollable<span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> Manage async system resources for WASI 0.1
</span></span><span class="z-source z-rust"><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">derive</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">Debug<span class="z-punctuation z-separator z-rust">,</span> Clone</span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
</span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-entity z-name z-struct z-rust">Reactor</span> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-other z-member z-rust">inner</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-meta z-generic z-rust">Rc<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-meta z-generic z-rust">RefCell<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>InnerReactor<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span>,
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> The private, internal `Reactor` implementation - factored out so we can take
</span></span><span class="z-source z-rust"><span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> a lock of the whole.
</span></span><span class="z-source z-rust"><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">derive</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">Debug</span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
</span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-entity z-name z-struct z-rust">InnerReactor</span> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-other z-member z-rust">poller</span><span class="z-punctuation z-separator z-type z-rust">:</span> Poller,
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-other z-member z-rust">wakers</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-meta z-generic z-rust">HashMap<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>EventKey, Waker<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span>,
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span> </span><span class="z-meta z-impl z-rust"><span class="z-entity z-name z-impl z-rust">Reactor</span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> Create a new instance of `Reactor`
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-modifier z-rust">pub</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-other z-rust">crate</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">new</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> <span class="z-storage z-type z-rust">Self</span></span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-storage z-type z-rust">Self</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            inner<span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust">Rc<span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">RefCell<span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>InnerReactor <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">                poller<span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust">Poller<span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">                wakers<span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust">HashMap<span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">            </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Rc&LTRefCell<inner>> çš„åŸå› æ˜¯å› ä¸ºæˆ‘ä»¬æ§åˆ¶äº†æ‰€æœ‰çš„è®¿é—®æ–¹æ³•ã€‚æˆ‘ä»¬ä¿è¯å®ƒä»¬æ€»æ˜¯çŸ­æš‚çš„ï¼Œè€Œä¸”æ°¸è¿œä¸ä¼šé‡å ã€‚è¿™åè¿‡æ¥ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç§æ–¹ä¾¿çš„æ–¹å¼ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿåœ¨ &self è€Œä¸æ˜¯ &mut self ä¸Šè°ƒç”¨æ–¹æ³•ã€‚è¯´åˆ°è¿™é‡Œï¼Œæ˜¯æ—¶å€™å®ç°ç¬¬ä¸€ä¸ªæ–¹æ³•äº† - è¿™æ˜¯ä¸€ç§åœ¨å¯è½®è¯¢çš„å¯¹è±¡ä¸Šæ³¨å†Œå…³æ³¨çš„æ–¹æ³•ã€‚ <h3 id=zai-pollable-zhong-zhu-ce-guan-zhu><a aria-label="Anchor link for: zai-pollable-zhong-zhu-ce-guan-zhu" class="header-anchor no-hover-padding" href=#zai-pollable-zhong-zhu-ce-guan-zhu><span aria-hidden=true class=link-icon></span></a> åœ¨ Pollable ä¸­æ³¨å†Œå…³æ³¨</h3> <p>è¿™ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªå¼‚æ­¥æ–¹æ³• wait_forï¼Œå…è®¸æˆ‘ä»¬çš„ååº”å™¨å¼‚æ­¥ç­‰å¾…ï¼Œç›´åˆ°ä¸ Pollable ç›¸å…³çš„è°ƒç”¨å‡†å¤‡å¥½æ‰§è¡Œã€‚</p> <pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span> </span><span class="z-meta z-impl z-rust"><span class="z-entity z-name z-impl z-rust">Reactor</span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> Wait for the pollable to resolve.
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-modifier z-rust">pub</span> async <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">wait_for</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&</span><span class="z-variable z-parameter z-rust">self</span>, <span class="z-variable z-parameter z-rust">pollable</span><span class="z-punctuation z-separator z-rust">:</span> Pollable</span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> pollable <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-type z-rust">Some</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>pollable</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> key <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-type z-rust">None</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> This function is the core loop of our function; it will be called
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> multiple times as the future is resolving.
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-meta z-path z-rust">future<span class="z-punctuation z-accessor z-rust">::</span></span>poll_fn<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">|</span></span></span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-variable z-parameter z-rust">cx</span><span class="z-punctuation z-section z-parameters z-end z-rust">|</span></span> </span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust">            <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Start by taking a lock on the reactor. This is single-threaded
</span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust">            <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> and short-lived, so it will never be contended.
</span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust">            <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> reactor <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>inner<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">borrow_mut</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust">
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust">            <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Schedule interest in the `pollable` on the first iteration. On
</span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust">            <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> every iteration, register the waker with the reactor.
</span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust">            <span class="z-storage z-type z-rust">let</span> key <span class="z-keyword z-operator z-assignment z-rust">=</span> key<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">get_or_insert_with</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">|</span></span></span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">|</span></span> </span><span class="z-meta z-function z-closure z-rust">reactor<span class="z-punctuation z-accessor z-dot z-rust">.</span>poller<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">insert</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>pollable<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">take</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">unwrap</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust">            reactor<span class="z-punctuation z-accessor z-dot z-rust">.</span>wakers<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">insert</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-arithmetic z-rust">*</span>key<span class="z-punctuation z-separator z-rust">,</span> cx<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">waker</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">clone</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust">
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust">            <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Check whether we're ready or need to keep waiting. If we're
</span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust">            <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> ready, we clean up after ourselves.
</span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust">            <span class="z-keyword z-control z-rust">if</span> reactor<span class="z-punctuation z-accessor z-dot z-rust">.</span>poller<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">get</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>key</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">unwrap</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">ready</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                reactor<span class="z-punctuation z-accessor z-dot z-rust">.</span>poller<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">remove</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-arithmetic z-rust">*</span>key</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                reactor<span class="z-punctuation z-accessor z-dot z-rust">.</span>wakers<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">remove</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>key</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                <span class="z-meta z-path z-rust">Poll<span class="z-punctuation z-accessor z-rust">::</span></span>Ready<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span> <span class="z-keyword z-control z-rust">else</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                <span class="z-meta z-path z-rust">Poll<span class="z-punctuation z-accessor z-rust">::</span></span>Pending
</span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust">        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-punctuation z-accessor z-dot z-rust">.</span>await
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre> <p>è¿™é‡Œçš„å¥½å¤„æ˜¯ï¼Œä¸å…¶ä»–è¿è¡Œæ—¶ä¸åŒï¼Œæˆ‘ä»¬ä»…åœ¨æ“ä½œä¸Šæ³¨å†Œå…³æ³¨ã€‚è¿™æ„å‘³ç€â€œç­‰å¾…æ­¤æ“ä½œå‡†å¤‡å¥½â€ä»…éœ€è°ƒç”¨ <code>reactor.wait_for(pollable).await</code>ã€‚è¿™ä¸å…¶ä»–è½®è¯¢æ¨¡å‹ä¸­æ‰€éœ€çš„ <code>syscall</code> æ“ä½œç›¸æ¯”ï¼Œæœ‰å¾ˆå¤§çš„ä¸åŒï¼Œå¹¶ä¸”æ„å‘³ç€æˆ‘ä»¬å¯ä»¥å°†ååº”å™¨æ‰€éœ€çš„æ‰€æœ‰ä¸å˜æ€§ç›´æ¥ç¼–ç ä¸ºå®ƒçš„ä¸€éƒ¨åˆ†ã€‚</p> <p>åœ¨ Rust WG Async çš„æœ€è¿‘å¯¹è¯ä¸­ï¼Œæˆ‘ä»¬ä¸€ç›´åœ¨è®¨è®ºå°†æŸç§ç±»å‹çš„ååº”å™¨é’©å­ä½œä¸º <code>Context</code>çš„ä¸€éƒ¨åˆ†æ˜¯å¦åˆé€‚ï¼Œæˆ–è€…æ˜¯å¦æœ‰å…¶ä»–æ›´å¥½çš„æœºåˆ¶ã€‚ä»è¿™ä¸ªä¾‹å­æ¥çœ‹ï¼Œæˆ‘è®¤ä¸ºå°½ç®¡å¯ä»¥é€šè¿‡ <code>future</code> çš„ <code>Context</code> å…±äº«ååº”å™¨ï¼Œä½†åœ¨é«˜å±‚æ¬¡ä¸Šï¼Œè¿™ç§æ˜ å°„æ€»æ˜¯æ˜ å°„åˆ°åº•å±‚å‡½æ•°è°ƒç”¨ã€‚è¿™è‡³å°‘è®©æˆ‘å¯¹è¿™æ˜¯å¦æ˜¯æœ€è‡ªç„¶çš„æ˜ å°„äº§ç”Ÿäº†æ€€ç–‘ã€‚</p> <h3 id=zu-sai-zhi-dao-shi-jian-jiu-xu><a aria-label="Anchor link for: zu-sai-zhi-dao-shi-jian-jiu-xu" class="header-anchor no-hover-padding" href=#zu-sai-zhi-dao-shi-jian-jiu-xu><span aria-hidden=true class=link-icon></span></a> é˜»å¡ç›´åˆ°äº‹ä»¶å°±ç»ª</h3> <p>æœ‰äº†è¿™äº›ï¼Œæˆ‘ä»¬å°±å¯ä»¥å›´ç»• Poller::block_until è°ƒç”¨å®ç°åŒ…è£…å™¨äº†ã€‚æ ¹æ®æˆ‘ä»¬çš„å®ç°ï¼Œå®ƒå°†ç­‰å¾…æ‰€æœ‰å·²æ³¨å†Œçš„è½®è¯¢è€…ï¼ˆpollersï¼‰ï¼Œå¹¶ä¸ºé‚£äº›å‡†å¤‡å¥½è¢«å”¤é†’çš„è½®è¯¢è€…è¿”å›ä¸€ä¸ª EventKeys åˆ—è¡¨ã€‚æˆ‘ä»¬è¦åšçš„å°±æ˜¯éå†é”®åˆ—è¡¨ï¼Œå¹¶è°ƒç”¨æ¯ä¸ªç›¸å…³çš„å”¤é†’ç¨‹åºï¼š</p> <pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Block until new events are ready. Calls the respective wakers once done.
</span></span><span class="z-source z-rust"><span class="z-storage z-modifier z-rust">pub</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-other z-rust">crate</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">block_until</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&</span><span class="z-variable z-parameter z-rust">self</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> reactor <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>inner<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">borrow_mut</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-keyword z-control z-rust">for</span> key <span class="z-keyword z-operator z-rust">in</span> reactor<span class="z-punctuation z-accessor z-dot z-rust">.</span>poller<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">block_until</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-keyword z-control z-rust">match</span> reactor<span class="z-punctuation z-accessor z-dot z-rust">.</span>wakers<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">get</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&</span>key</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            <span class="z-support z-type z-rust">Some</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>waker</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">=></span> waker<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">wake_by_ref</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            <span class="z-support z-type z-rust">None</span> <span class="z-keyword z-operator z-rust">=></span> <span class="z-support z-macro z-rust">panic!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>tried to wake the waker for non-existent `{key:?}`<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre> <p>ä¹ä¸€çœ‹ä½¿ç”¨å”¤é†’å™¨çš„æ–¹æ¡ˆæœ‰ç‚¹ç¬¨ï¼Œå› ä¸º WASI 0.2 ç›®å‰æ˜¯å•çº¿ç¨‹çš„ï¼Œé»˜è®¤æƒ…å†µä¸‹å®ƒæ€»æ˜¯åªå”¤é†’ä¸€ä¸ªå”¤é†’å™¨ï¼Œç„¶è€Œï¼Œä½¿ç”¨å”¤é†’å™¨æ¥åŒºåˆ†äº‹ä»¶æ˜¯å¸¸è§ä¸”è¢«æ¨èçš„åšæ³•ã€‚å¹¶å‘åŸè¯­å¯ä»¥æ„å»ºè‡ªå·±çš„å”¤é†’å™¨ä»¥ä¾¿è·Ÿè¸ªæ ‡è¯†å®ç°æ›´ç²¾ç¡®åœ°å”¤é†’ã€‚æˆ‘ä»¬æ— æ³•æ§åˆ¶åº“æ„å»ºçš„å”¤é†’å™¨ï¼Œä¸ºæ­¤æˆ‘ä»¬ä¸å¾—ä¸å”¤é†’æ‰€æœ‰çš„å”¤é†’å™¨ï¼Œå³ä½¿é»˜è®¤æƒ…å†µä¸‹å®ƒä»¬ä»€ä¹ˆéƒ½ä¸åšã€‚</p> <h2 id=zu-sai-block-on-luo-ji-she-ji><a aria-label="Anchor link for: zu-sai-block-on-luo-ji-she-ji" class="header-anchor no-hover-padding" href=#zu-sai-block-on-luo-ji-she-ji><span aria-hidden=true class=link-icon></span></a> é˜»å¡ï¼ˆblock_onï¼‰é€»è¾‘è®¾è®¡</h2> <p>ç°åœ¨æˆ‘ä»¬å·²ç»å®Œæˆäº†ååº”å™¨ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹æ³•æ¥é©±åŠ¨å®ƒã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†å®šä¹‰ä¸€ä¸ªåä¸º block_on çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°æ¥å—ä¸€ä¸ªè¿”å› future çš„é—­åŒ…ï¼Œå¹¶ä½¿å…¶å¯ä»¥è®¿é—®ååº”å™¨ã€‚åªè¦é—­åŒ…è¿”å›çš„ Future å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œä»»åŠ¡å°±ä¼šä¸æ–­å–å¾—è¿›å±•â€”â€”æ¯æ¬¡ Future è¿”å› Pending æ—¶ï¼Œç­‰å¾…ååº”å™¨ã€‚</p> <p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†æ‰‹åŠ¨é©±åŠ¨ Futureï¼Œé¦–å…ˆå®šä¹‰æˆ‘ä»¬è‡ªå·±çš„ Waker å®ä¾‹ã€‚æˆ‘ä»¬ä¸æ”¯æŒä»»ä½•å½¢å¼çš„ spawn å‡½æ•°ï¼Œè€Œæ˜¯ä¾èµ–ç”¨æˆ·åˆ©ç”¨å¹¶å‘ç»“æ„åº“å®ç°ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç›´æ¥å°†å…¶è®¾ç½®ä¸ºç©ºæ“ä½œï¼ˆnoopï¼‰ã€‚</p> <pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> Construct a new no-op waker
</span></span><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> NOTE: we can remove this once &LThttps://github.com/rust-lang/rust/issues/98286> lands
</span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">noop_waker</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> Waker</span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">const</span> <span class="z-constant z-other z-rust">VTABLE</span><span class="z-punctuation z-separator z-rust">:</span> RawWakerVTable <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">RawWakerVTable<span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Cloning just returns a new no-op raw waker
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">        <span class="z-keyword z-operator z-bitwise z-rust">|</span><span class="z-keyword z-operator z-rust">_</span><span class="z-keyword z-operator z-bitwise z-rust">|</span> <span class="z-constant z-other z-rust">RAW</span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> `wake` does nothing
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">        <span class="z-keyword z-operator z-bitwise z-rust">|</span><span class="z-keyword z-operator z-rust">_</span><span class="z-keyword z-operator z-bitwise z-rust">|</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> `wake_by_ref` does nothing
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">        <span class="z-keyword z-operator z-bitwise z-rust">|</span><span class="z-keyword z-operator z-rust">_</span><span class="z-keyword z-operator z-bitwise z-rust">|</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Dropping does nothing as we don't allocate anything
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">        <span class="z-keyword z-operator z-bitwise z-rust">|</span><span class="z-keyword z-operator z-rust">_</span><span class="z-keyword z-operator z-bitwise z-rust">|</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">    </span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">const</span> <span class="z-constant z-other z-rust">RAW</span><span class="z-punctuation z-separator z-rust">:</span> RawWaker <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">RawWaker<span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">ptr<span class="z-punctuation z-accessor z-rust">::</span></span>null<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-constant z-other z-rust">VTABLE</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> SAFETY: all fields are no-ops, so this is safe
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-modifier z-rust">unsafe</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span> <span class="z-meta z-path z-rust">Waker<span class="z-punctuation z-accessor z-rust">::</span></span>from_raw<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-other z-rust">RAW</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre> <p>æ¥ä¸‹æ¥æ˜¯çœŸæ­£çš„ block_on å®ç°ã€‚æ ¸å¿ƒé€»è¾‘åŸºæœ¬ä¸Šæ˜¯ä¸€ä¸ªå¾ªç¯ { match {} } è¯­å¥ï¼Œå®ƒåªæ˜¯åœ¨æ¯æ¬¡è¿­ä»£æ—¶è°ƒç”¨ reactor.block_untilï¼Œç›´åˆ° Future å®Œæˆã€‚</p> <pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> Start the event loop
</span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">block_on</span></span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>F, Fut<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">f</span><span class="z-punctuation z-separator z-rust">:</span> F</span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Fut</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>Output
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-return-type z-rust"></span></span><span class="z-meta z-function z-rust"><span class="z-keyword z-other z-rust">where</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust">    F<span class="z-punctuation z-separator z-rust">:</span> FnOnce<span class="z-punctuation z-section z-group z-begin z-rust">(</span>Reactor<span class="z-punctuation z-section z-group z-end z-rust">)</span> -> Fut,
</span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust">    Fut<span class="z-punctuation z-separator z-rust">:</span> Future,
</span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"></span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Construct the reactor
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> reactor <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">Reactor<span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Create the future and pin it so it can be polled
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> fut <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>f</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>reactor<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">clone</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> fut <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-macro z-rust">pin!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>fut</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Create a new context to be passed to the future.
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> waker <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-function z-rust">noop_waker</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> cx <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">Context<span class="z-punctuation z-accessor z-rust">::</span></span>from_waker<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&</span>waker</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Either the future completes and we return, or some IO is happening
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> and we wait.
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-keyword z-control z-rust">loop</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-keyword z-control z-rust">match</span> fut<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">as_mut</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">poll</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> cx</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            <span class="z-meta z-path z-rust">Poll<span class="z-punctuation z-accessor z-rust">::</span></span>Ready<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>res</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">=></span> <span class="z-keyword z-control z-rust">return</span> res<span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            <span class="z-meta z-path z-rust">Poll<span class="z-punctuation z-accessor z-rust">::</span></span>Pending <span class="z-keyword z-operator z-rust">=></span> reactor<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">block_until</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre> <p>è‡³æ­¤ï¼Œæˆ‘ä»¬çš„å¼‚æ­¥è¿è¡Œæ—¶å°±å®Œæˆäº†ï¼</p> <h2 id=ben-di-zhi-xing-qi-luo-ji><a aria-label="Anchor link for: ben-di-zhi-xing-qi-luo-ji" class="header-anchor no-hover-padding" href=#ben-di-zhi-xing-qi-luo-ji><span aria-hidden=true class=link-icon></span></a> æœ¬åœ°æ‰§è¡Œå™¨é€»è¾‘</h2> <p>WASI 0.2 æ˜¯å•çº¿ç¨‹çš„ï¼Œæœ¬è´¨ä¸Šä¸éœ€è¦è®¿é—® task::spawn æŠ½è±¡ã€‚åœ¨åŒæ­¥ Rust ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨çº¿ç¨‹æ¥ç»“åˆå¹¶è¡Œæ€§å’Œå¹¶å‘æ€§ï¼›ä½†åœ¨å¼‚æ­¥ Rust ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åˆ†ç¦»å®ƒä»¬ã€‚<a href=https://docs.rs/futures-concurrency/latest/futures_concurrency/>futures-concurrency</a> åº“æä¾›äº†æ‚¨éœ€è¦çš„è®¿é—®ä»»ä½•å¹¶å‘æ¨¡å¼çš„èƒ½åŠ›ï¼›è¿™æ„å‘³ç€åœ¨æ²¡æœ‰å¹¶è¡Œæ€§çš„æƒ…å†µä¸‹ä¸éœ€è¦æ‰§è¡Œå™¨ã€‚</p> <p>ç›¸åï¼ŒAPIï¼ˆå¦‚<a href=https://docs.rs/futures-concurrency/latest/futures_concurrency/future/trait.Join.html#impl-Join-for-Vec%3CFut%3E>Vec::join</a>å’Œ<a href=https://docs.rs/futures-concurrency/latest/futures_concurrency/stream/struct.StreamGroup.html>StreamGroup</a>ï¼‰ç”šè‡³æä¾›äº†è®¿é—®æ— ç•Œå¹¶å‘åŸè¯­çš„æ–¹æ³•ï¼Œäººä»¬é€šå¸¸åœ¨â€œæœ¬åœ°æ‰§è¡Œå™¨â€ä¸­ä½¿ç”¨â€”â€”ä½†æ²¡æœ‰ä»»ä½•æŠ½è±¡çš„ä½œç”¨åŸŸç”Ÿå‘½å‘¨æœŸé—®é¢˜ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•åœ¨ä¸ä¾èµ–â€œæœ¬åœ°ä»»åŠ¡â€çš„æƒ…å†µä¸‹å¹¶å‘åœ°å‘å‡ºä¸¤ä¸ªå•ç‹¬çš„HTTPè¯·æ±‚ï¼š</p> <pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust">   <span class="z-support z-function z-rust">block_on</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">|</span></span></span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-variable z-parameter z-rust">reactor</span><span class="z-punctuation z-section z-parameters z-end z-rust">|</span></span> </span><span class="z-meta z-function z-closure z-rust">async <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust">        <span class="z-storage z-type z-rust">let</span> client <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">Client<span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>reactor</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span> <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> &LT- using an unpublished wrapper around `wasi::http`
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust">
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust">        <span class="z-storage z-type z-rust">let</span> a <span class="z-keyword z-operator z-assignment z-rust">=</span> async <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            <span class="z-storage z-type z-rust">let</span> url <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>https://example.com<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">parse</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">unwrap</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            <span class="z-storage z-type z-rust">let</span> req <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">Request<span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">Method<span class="z-punctuation z-accessor z-rust">::</span></span>Get<span class="z-punctuation z-separator z-rust">,</span> url</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            <span class="z-storage z-type z-rust">let</span> res <span class="z-keyword z-operator z-assignment z-rust">=</span> client<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">send</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>req</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>await<span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            <span class="z-storage z-type z-rust">let</span> body <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-function z-rust">read_to_end</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>res</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>await<span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            <span class="z-storage z-type z-rust">let</span> body <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-type z-rust">String</span><span class="z-meta z-path z-rust"><span class="z-punctuation z-accessor z-rust">::</span></span>from_utf8<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>body</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">unwrap</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            <span class="z-support z-macro z-rust">println!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span><span class="z-constant z-other z-placeholder z-rust">{body}</span><span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust">
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust">        <span class="z-storage z-type z-rust">let</span> b <span class="z-keyword z-operator z-assignment z-rust">=</span> async <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            <span class="z-storage z-type z-rust">let</span> url <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>https://example.com<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">parse</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">unwrap</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            <span class="z-storage z-type z-rust">let</span> req <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">Request<span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">Method<span class="z-punctuation z-accessor z-rust">::</span></span>Get<span class="z-punctuation z-separator z-rust">,</span> url</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            <span class="z-storage z-type z-rust">let</span> res <span class="z-keyword z-operator z-assignment z-rust">=</span> client<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">send</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>req</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>await<span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            <span class="z-storage z-type z-rust">let</span> body <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-function z-rust">read_to_end</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>res</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>await<span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            <span class="z-storage z-type z-rust">let</span> body <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-type z-rust">String</span><span class="z-meta z-path z-rust"><span class="z-punctuation z-accessor z-rust">::</span></span>from_utf8<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>body</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">unwrap</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            <span class="z-support z-macro z-rust">println!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span><span class="z-constant z-other z-placeholder z-rust">{body}</span><span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust">
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust">        <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>a<span class="z-punctuation z-separator z-rust">,</span> b</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">join</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>await<span class="z-punctuation z-terminator z-rust">;</span> <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> concurrently await both `a` and `b`.
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span><span class="z-source z-rust">}
</span></code></pre> <h2 id=jie-yu><a aria-label="Anchor link for: jie-yu" class="header-anchor no-hover-padding" href=#jie-yu><span aria-hidden=true class=link-icon></span></a> ç»“è¯­</h2> <p>åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘è§£é‡Šäº† WSI çš„è½®è¯¢æ¨¡å‹ï¼Œå¹¶é€æ­¥å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨å®ƒæ¥æ„å»ºè‡ªå·±çš„å¼‚æ­¥è¿è¡Œæ—¶ã€‚æˆ‘å¸Œæœ›è¿™å¯¹å¼‚æ­¥ Rust è¿è¡Œæ—¶çš„ç»´æŠ¤è€…ä»¥åŠæƒ³è¦å®Œæˆè‡ªå·±çš„ç¼–å†™åŠ¨ä½œçš„ä¸šä½™çˆ±å¥½è€…æœ‰ç”¨ã€‚å¦‚æœä½ åªæƒ³ä½¿ç”¨æˆ‘ä»Šå¤©åœ¨è¿™é‡Œåˆ†äº«çš„ä»£ç ï¼Œä½ å¯ä»¥é€šè¿‡å®‰è£… <a href=https://docs.rs/wasi-async-runtime/latest/wasi_async_runtime/>wasi-async-runtime crate </a>æ¥å®ç°ã€‚</p> <h2 id=can-kao><a aria-label="Anchor link for: can-kao" class="header-anchor no-hover-padding" href=#can-kao><span aria-hidden=true class=link-icon></span></a> å‚è€ƒï¼š</h2> <ol><li><a href=https://blog.yoshuawuyts.com/building-an-async-runtime-for-wasi/#the-wasi-0-2-polling-model>https://blog.yoshuawuyts.com/building-an-async-runtime-for-wasi/#the-wasi-0-2-polling-model</a><li><a href=https://blog.yoshuawuyts.com/building-an-async-runtime-for-wasi/#designing-the-poller-abstraction>https://blog.yoshuawuyts.com/building-an-async-runtime-for-wasi/#designing-the-poller-abstraction</a><li><a href=https://blog.yoshuawuyts.com/building-an-async-runtime-for-wasi/#designing-the-reactor-abstraction>https://blog.yoshuawuyts.com/building-an-async-runtime-for-wasi/#designing-the-reactor-abstraction</a><li><a href=https://blog.yoshuawuyts.com/building-an-async-runtime-for-wasi/#registering-interest-in-a-pollable>https://blog.yoshuawuyts.com/building-an-async-runtime-for-wasi/#registering-interest-in-a-pollable</a><li><a href=https://blog.yoshuawuyts.com/building-an-async-runtime-for-wasi/#blocking-until-events-are-ready>https://blog.yoshuawuyts.com/building-an-async-runtime-for-wasi/#blocking-until-events-are-ready</a><li><a href=https://blog.yoshuawuyts.com/building-an-async-runtime-for-wasi/#designing-the-block-on-abstraction>https://blog.yoshuawuyts.com/building-an-async-runtime-for-wasi/#designing-the-block-on-abstraction</a><li><a href=https://blog.yoshuawuyts.com/building-an-async-runtime-for-wasi/#on-the-absence-of-a-local-executor>https://blog.yoshuawuyts.com/building-an-async-runtime-for-wasi/#on-the-absence-of-a-local-executor</a><li><a href=https://blog.yoshuawuyts.com/building-an-async-runtime-for-wasi/#conclusion>https://blog.yoshuawuyts.com/building-an-async-runtime-for-wasi/#conclusion</a><li><a href=https://docs.rs/async-std>https://docs.rs/async-std</a><li><a href=https://docs.rs/runtime>https://docs.rs/runtime</a><li><a href=https://docs.rs/polling>https://docs.rs/polling</a><li><a href=https://github.com/smol-rs/async-io>https://github.com/smol-rs/async-io</a><li><a href=https://docs.rs/smol>https://docs.rs/smol</a><li><a href=https://docs.rs/wasi-async-runtime/latest/wasi_async_runtime/>https://docs.rs/wasi-async-runtime/latest/wasi_async_runtime/</a><li><a href=https://bytecodealliance.org/articles/WASI-0.2>https://bytecodealliance.org/articles/WASI-0.2</a><li><a href=https://docs.rs/smol/latest/smol/>https://docs.rs/smol/latest/smol/</a><li><a href=https://docs.rs/monoio/latest/monoio/>https://docs.rs/monoio/latest/monoio/</a><li><a href=https://docs.rs/glommio/latest/glommio/>https://docs.rs/glommio/latest/glommio/</a><li><a href=https://docs.rs/tokio/latest/tokio/>https://docs.rs/tokio/latest/tokio/</a><li><a href=https://en.wikipedia.org/wiki/Io_uring>https://en.wikipedia.org/wiki/Io_uring</a><li><a href=https://learn.microsoft.com/en-us/windows/win32/api/ioringapi/>https://learn.microsoft.com/en-us/windows/win32/api/ioringapi/</a><li><a href=https://docs.rs/wasi/latest/wasi/io/poll/struct.Pollable.html>https://docs.rs/wasi/latest/wasi/io/poll/struct.Pollable.html</a><li><a href=https://docs.rs/wasi/latest/wasi/io/poll/fn.poll.html>https://docs.rs/wasi/latest/wasi/io/poll/fn.poll.html</a><li><a href=https://github.com/bytecodealliance/cargo-component>https://github.com/bytecodealliance/cargo-component</a><li><a href=https://blog.yoshuawuyts.com/why-async-rust/#ad-hoc-concurrency>https://blog.yoshuawuyts.com/why-async-rust/#ad-hoc-concurrency</a><li><a href=https://doc.rust-lang.org/std/task/struct.Waker.html>https://doc.rust-lang.org/std/task/struct.Waker.html</a><li><a href=https://docs.rs/slab/latest/slab/>https://docs.rs/slab/latest/slab/</a><li><a href=https://docs.rs/futures-concurrency/latest/futures_concurrency/>https://docs.rs/futures-concurrency/latest/futures_concurrency/</a><li><a href=https://docs.rs/futures-concurrency/latest/futures_concurrency/future/trait.Join.html#impl-Join-for-Vec%3CFut%3E>https://docs.rs/futures-concurrency/latest/futures_concurrency/future/trait.Join.html#impl-Join-for-Vec%3CFut%3E</a><li><a href=https://docs.rs/futures-concurrency/latest/futures_concurrency/stream/struct.StreamGroup.html>https://docs.rs/futures-concurrency/latest/futures_concurrency/stream/struct.StreamGroup.html</a><li><a href=https://docs.rs/wasi-async-runtime/latest/wasi_async_runtime/>https://docs.rs/wasi-async-runtime/latest/wasi_async_runtime/</a></ol> <nav class=article-navigation><div></div><div><a aria-label=">>>" aria-describedby=right_title href=https://blog.windeye.top/blog/githubblogbyzola/>>>>Â <span class=arrow>â†’</span></a><p aria-hidden=true id=right_title>ç”¨ zola åœ¨ github ä¸Šå»ºç«‹ä¸ªäººåšå®¢</div></nav> <div class=comments data-category=Announcements data-category-id=DIC_kwDOK70hhM4Cb4Qn data-dark-theme=noborder_dark data-input-position=top data-lang=zh-Hans data-lazy-loading=true data-light-theme=noborder_light data-mapping=specific data-reactions-enabled=1 data-repo=ziyouwa/blog-commit data-repo-id=R_kgDOK70hhA data-strict=1 data-term=asyncruntimeforwasi0-2 id=comments><script async src=https://blog.windeye.top/js/giscus.min.js></script><noscript>You need JavaScript to view the comments.</noscript></div> <div id=button-container><div id=toc-floating-container><input class=toggle id=toc-toggle type=checkbox><label class=overlay for=toc-toggle></label><label class=button for=toc-toggle id=toc-button title=åˆ‡æ¢ç›®å½•><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="M414.82-193.094q-18.044 0-30.497-12.32-12.453-12.319-12.453-30.036t12.453-30.086q12.453-12.37 30.497-12.37h392.767q17.237 0 29.927 12.487 12.69 12.486 12.69 30.203 0 17.716-12.69 29.919t-29.927 12.203H414.82Zm0-244.833q-18.044 0-30.497-12.487Q371.87-462.9 371.87-480.45t12.453-29.92q12.453-12.369 30.497-12.369h392.767q17.237 0 29.927 12.511 12.69 12.512 12.69 29.845 0 17.716-12.69 30.086-12.69 12.37-29.927 12.37H414.82Zm0-245.167q-18.044 0-30.497-12.32t-12.453-30.037q0-17.716 12.453-30.086 12.453-12.369 30.497-12.369h392.767q17.237 0 29.927 12.486 12.69 12.487 12.69 30.203 0 17.717-12.69 29.92-12.69 12.203-29.927 12.203H414.82ZM189.379-156.681q-32.652 0-55.878-22.829t-23.226-55.731q0-32.549 23.15-55.647 23.151-23.097 55.95-23.097 32.799 0 55.313 23.484 22.515 23.484 22.515 56.246 0 32.212-22.861 54.893-22.861 22.681-54.963 22.681Zm0-245.167q-32.652 0-55.878-23.134-23.226-23.135-23.226-55.623 0-32.487 23.467-55.517t56.12-23.03q32.102 0 54.721 23.288 22.62 23.288 22.62 55.775 0 32.488-22.861 55.364-22.861 22.877-54.963 22.877Zm-.82-244.833q-32.224 0-55.254-23.288-23.03-23.289-23.03-55.623 0-32.333 23.271-55.364 23.272-23.03 55.495-23.03 32.224 0 55.193 23.288 22.969 23.289 22.969 55.622 0 32.334-23.21 55.364-23.21 23.031-55.434 23.031Z"/></svg></label><div class=toc-content><div class=toc-container><ul><li><a href=https://blog.windeye.top/blog/asyncruntimeforwasi0-2/#wasi-0-2-lun-xun-mo-xing>WASI 0.2 è½®è¯¢æ¨¡å‹</a><li><a href=https://blog.windeye.top/blog/asyncruntimeforwasi0-2/#lun-xun-qi-she-ji>è½®è¯¢å™¨è®¾è®¡</a><li><a href=https://blog.windeye.top/blog/asyncruntimeforwasi0-2/#fan-ying-qi-she-ji>ååº”å™¨è®¾è®¡</a> <ul><li><a href=https://blog.windeye.top/blog/asyncruntimeforwasi0-2/#zai-pollable-zhong-zhu-ce-guan-zhu>åœ¨ Pollable ä¸­æ³¨å†Œå…³æ³¨</a><li><a href=https://blog.windeye.top/blog/asyncruntimeforwasi0-2/#zu-sai-zhi-dao-shi-jian-jiu-xu>é˜»å¡ç›´åˆ°äº‹ä»¶å°±ç»ª</a></ul><li><a href=https://blog.windeye.top/blog/asyncruntimeforwasi0-2/#zu-sai-block-on-luo-ji-she-ji>é˜»å¡ï¼ˆblock_onï¼‰é€»è¾‘è®¾è®¡</a><li><a href=https://blog.windeye.top/blog/asyncruntimeforwasi0-2/#ben-di-zhi-xing-qi-luo-ji>æœ¬åœ°æ‰§è¡Œå™¨é€»è¾‘</a><li><a href=https://blog.windeye.top/blog/asyncruntimeforwasi0-2/#jie-yu>ç»“è¯­</a><li><a href=https://blog.windeye.top/blog/asyncruntimeforwasi0-2/#can-kao>å‚è€ƒï¼š</a></ul></div></div></div><a class=no-hover-padding href=#comments id=comments-button title=è½¬åˆ°è¯„è®ºåŒº> <svg viewbox="0 0 20 20" fill=currentColor><path d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule=evenodd fill-rule=evenodd /></svg> </a><a class=no-hover-padding href=# id=top-button title=è¿”å›é¡µé¢é¡¶éƒ¨> <svg viewbox="0 0 20 20" fill=currentColor><path d="M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z"/></svg> </a></div> <span class=hidden id=copy-success> å·²å¤åˆ¶! </span> <span class=hidden id=copy-init> å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿ </span> <script defer src=https://blog.windeye.top/js/copyCodeToClipboard.min.js></script> <footer><section><nav class="socials nav-navs"><ul><li><a class="nav-links no-hover-padding social" href=https://blog.windeye.top/atom.xml> <img alt=feed src=https://blog.windeye.top/social_icons/rss.svg title=feed> </a><li class=js><a class="nav-links no-hover-padding social" data-encoded-email="eWpzc3NAaG90bWFpbC5jb20=" href=#><img alt=email src=https://blog.windeye.top/social_icons/email.svg title=email> </a><li><a class="nav-links no-hover-padding social" rel=" me" href=https://github.com/ziyouwa/> <img alt=github src=https://blog.windeye.top/social_icons/github.svg title=github> </a></ul></nav><nav class=nav-navs><small> <ul><li><a class="nav-links no-hover-padding" href=https://blog.windeye.top/about/> å…³äº </a><li><a class="nav-links no-hover-padding" href=https://blog.windeye.top/privacy/> éšç§æ”¿ç­– </a></ul> </small></nav><div class=credits><small> ç½‘ç«™åŸºäº <a href=https://www.getzola.org>Zola</a> å’Œ <a href=https://github.com/welpo/tabi>tabi</a> </small></div></section><script async src=https://blog.windeye.top/js/decodeMail.min.js></script></footer> 