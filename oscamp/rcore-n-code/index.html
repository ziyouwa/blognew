<!doctype html><html lang=zh-Hans><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://blog.windeye.top name=base><title>描边大叔的博客 • rCore-N代码分析</title><link href=https://blog.windeye.top/img/seedling.png rel=icon type=image/png><link href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 105 55"><text y=".7em" font-size="82">🦊</text></svg>' rel=icon><link href=https://blog.windeye.top/atom.xml rel=alternate title=描边大叔的博客 type=application/atom+xml><link href="https://blog.windeye.top/custom_subset.css?h=6de30382822eb2c02ee0" rel=stylesheet><link href="https://blog.windeye.top/main.css?h=03882d7b0d0cfe74b15f" rel=stylesheet><link href="https://blog.windeye.top/skins/zyw.css?h=4bbeae109422ff1bdcf0" rel=stylesheet><meta content="light dark" name=color-scheme><meta media="(prefers-color-scheme: light)" content=#ffffff name=theme-color><meta media="(prefers-color-scheme: dark)" content=#000000 name=theme-color><meta content=分析rCore-N的启动流程，为驱动移植做准备 name=description><meta content=分析rCore-N的启动流程，为驱动移植做准备 property=og:description><meta content="index, nofollow" name=robots><meta content=rCore-N代码分析 property=og:title><meta content=article property=og:type><meta content=zh_CN property=og:locale><meta content=https://blog.windeye.top/oscamp/rcore-n-code/ property=og:url><meta content=描边大叔的博客 property=og:site_name><meta content="default-src 'self';font-src 'self' data:;img-src 'self' https://* data:;media-src 'self' https://cdn.jsdelivr.net/;style-src 'self' https://giscus.app/default.css;frame-src player.vimeo.com https://www.youtube-nocookie.com giscus.app;connect-src 'self';script-src 'self'  giscus.app 'self'" http-equiv=Content-Security-Policy><noscript><link href=https://blog.windeye.top/no_js.css rel=stylesheet></noscript><script src=https://blog.windeye.top/js/initializeTheme.min.js></script><script defer src=https://blog.windeye.top/js/themeSwitcher.min.js></script><body><header><nav class=navbar><div class=nav-title><a class=home-title href=https://blog.windeye.top>描边大叔的博客</a></div><div class=nav-navs><ul><li><a class="nav-links no-hover-padding" href=https://blog.windeye.top/blog/> 博客 </a><li><a class="nav-links no-hover-padding" href=https://blog.windeye.top/archive/> 归档 </a><li><a class="nav-links no-hover-padding" href=https://blog.windeye.top/tags/> 标签 </a><li class="theme-switcher-wrapper js"><div aria-label=切换到暗模式 aria-pressed=false class=theme-switcher role=button tabindex=0 title=切换到暗/亮模式></div><div aria-hidden=true aria-label=将模式重置为网站默认值 class=theme-resetter role=button tabindex=0 title=将模式重置为网站默认值></div></ul></div></nav></header><div class=content><main><article><h1 class=article-title>rCore-N代码分析</h1><ul class=meta><li>2023年 11月17日</li> • <li title="共 1225 字">读完约需 7 分钟</ul><ul class="meta last-updated"><li>最后更新于 2023年 11月17日</ul><section class=body><h2 id=huan-jing><a aria-label="Anchor link for: huan-jing" class="header-anchor no-hover-padding" href=#huan-jing><span aria-hidden=true class=link-icon></span></a> 环境</h2><p>后续均以qemu为基础进行分析。主要对一些不熟悉、容易忘记或是还有疑问的地方进行记录。<h2 id=rust-main><a aria-label="Anchor link for: rust-main" class="header-anchor no-hover-padding" href=#rust-main><span aria-hidden=true class=link-icon></span></a> rust_main</h2><p>首先初始化的是hart 0, 不确定怎么翻译好，保留hart, 类似多处理器？驱动从<code>device::init</code>开始。<h3 id=device-init><a aria-label="Anchor link for: device-init" class="header-anchor no-hover-padding" href=#device-init><span aria-hidden=true class=link-icon></span></a> device::init()</h3><p>目前只调用了<code>net:init()</code>, 把NET_DEVICE_ADDR指向的地址0x10008000，然后以这块内存建立MmioTransport,再以这个MmioTransport, NET_QUEUE_SIZE，NET_BUFFER_LEN建立VirtIONet设备，然后是加锁，绑定到全局静态变量NET_DEVICE。最后调用mem::forgot使其处于不可访问状态。<p>疑问：<ol><li>到这里内存管理其实已经初始化完毕，那么这个NET_DEVICE_ADDR是物理地址还是内核S态的虚拟地址？<li>NET_DEVICE_ADDR只是一个起始地址，MmioTransport::new读取了magic, device_id, vresion, 这些是volread!直接从硬件寄存器读取的吗？<li>最后的forget作用是什么？我理解是后续就只能通过NET_DEVICE来访问这个虚拟网络设备了。</ol><h3 id=plic><a aria-label="Anchor link for: plic" class="header-anchor no-hover-padding" href=#plic><span aria-hidden=true class=link-icon></span></a> PLIC</h3><p>PLIC大致看了下文档，应该是集中管理中断的功能，先理清楚流程回头细看。<h4 id=plic-init><a aria-label="Anchor link for: plic-init" class="header-anchor no-hover-padding" href=#plic-init><span aria-hidden=true class=link-icon></span></a> plic:init()</h4><p>按<code>PLIC_BASE: 0xc00_0000</code>和<code>PLIC_PRIORITY_BIT: 3</code>来在plic中注册qemu的uart中断12～15的优先级，均设置为Priority::lowest()，如果hart是0还注册了一个中断8，<h4 id=plic-init-hart-hart-id><a aria-label="Anchor link for: plic-init-hart-hart-id" class="header-anchor no-hover-padding" href=#plic-init-hart-hart-id><span aria-hidden=true class=link-icon></span></a> plic::init_hart(hart_id);</h4><p>根据hart_id初始化每个hart的中断上下文，其中用到了get_context，它用3 * hart_id + 0 ~ 2 的方式来标识每个hart的M、S、U特权级。然后使能ini中注册的中断，最后调用Plic::set_threshold把中断临界值设置为Priority::any()。<p>疑问：<ol><li>中断8的具体作用是什么？<li>plic的相关调用，在crate的doc里面没有比较详细的介绍，不太明白具体作用。比如Priority各级别的区别和set_threshold的作用等</ol><h3 id=uart-init><a aria-label="Anchor link for: uart-init" class="header-anchor no-hover-padding" href=#uart-init><span aria-hidden=true class=link-icon></span></a> uart:init()</h3><p>串口设备的主要数据结构是<code>BufferedSerial</code>，它的<code>hardware</code>字段指向的是SerialHardware, 它是MmioUart8250类型，原理跟上面的MmioTransport类似，都是传入一个base地址，配合区间长度等参数将这段地址初始化为Uart8250类型的设备。 <code>uart:init()</code>初始化过程如下：<ol><li>定义全局变量BUFFERED_SERIAL，通过lazy_staic加载。<li><code>BufferedSerial::new</code>先初始化<code>MmioUart8250</code>设备，以<code>SERIAL_BASE_ADDRESS：0x1000_2000 + i * SERIAL_ADDRESS_STRIDE：0x1000</code>为base_address初始化串口设备，一共4个,并且初始化接收发送队列，均使用的是VecDeque, 队列长度由<code>DEFAULT_RX_BUFFER_SIZE</code>和<code>DEFAULT_RX_BUFFER_SIZE</code>定义。<li>调用hardware_init(),参数是波特率, 初始化三个波特率为<code>115200</code>和一个<code>6250000</code>的串口。<li><code>hardware.write_ier(0)</code> 开启第一个串口的中断使能。<li>调用read_msr(), 该函数返回串口数模转换器(Modem)的状态。贴一下<a href=https://docs.rs/uart8250/0.5.0/uart8250/uart/struct.MmioUart8250.html#method.read_msr>uart8205文档</a>的说明:</ol><pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">read_msr</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&</span><span class="z-variable z-parameter z-rust">self</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> <span class="z-storage z-type z-rust">u8</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-return-type z-rust">Read MSR <span class="z-punctuation z-section z-group z-begin z-rust">(</span>offset + 6<span class="z-punctuation z-section z-group z-end z-rust">)</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-return-type z-rust">
</span></span></span></code></pre><pre class=z-code><code><span class="z-text z-plain">Modem Status Register
</span><span class="z-text z-plain">Offset: +6 . This register is another read-only register that is here to inform your software about the current status of the modem. The modem accessed in this manner can either be an external modem, or an internal modem that uses a UART as an interface to the computer.
</span><span class="z-text z-plain">Bit	Notes
</span><span class="z-text z-plain">7	Carrier Detect
</span><span class="z-text z-plain">6	Ring Indicator
</span><span class="z-text z-plain">5	Data Set Ready
</span><span class="z-text z-plain">4	Clear To Send
</span><span class="z-text z-plain">3	Delta Data Carrier Detect
</span><span class="z-text z-plain">2	Trailing Edge Ring Indicator
</span><span class="z-text z-plain">1	Delta Data Set Ready
</span><span class="z-text z-plain">0	Delta Clear To Send
</span></code></pre><ol start=6><li>调用read_lsr()，返回线路状态。还是贴一下<a href=https://docs.rs/uart8250/0.5.0/uart8250/uart/struct.MmioUart8250.html#method.read_lsr>uart8205文档</a>的说明</ol><pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">read_lsr</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&</span><span class="z-variable z-parameter z-rust">self</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> <span class="z-storage z-type z-rust">u8</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-return-type z-rust">Read LSR <span class="z-punctuation z-section z-group z-begin z-rust">(</span>offset + 5<span class="z-punctuation z-section z-group z-end z-rust">)</span>
</span></span></span></code></pre><pre class=z-code><code><span class="z-text z-plain">Line Status Register
</span><span class="z-text z-plain">Offset: +5 . This register is used primarily to give you information on possible error conditions that may exist within the UART, based on the data that has been received. Keep in mind that this is a “read only” register, and any data written to this register is likely to be ignored or worse, cause different behavior in the UART. There are several uses for this information, and some information will be given below on how it can be useful for diagnosing problems with your serial data connection:
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">Bit	Notes
</span><span class="z-text z-plain">7	Error in Received FIFO
</span><span class="z-text z-plain">6	Empty Data Holding Registers
</span><span class="z-text z-plain">5	Empty Transmitter Holding Register
</span><span class="z-text z-plain">4	Break Interrupt
</span><span class="z-text z-plain">3	Framing Error
</span><span class="z-text z-plain">2	Parity Error
</span><span class="z-text z-plain">1	Overrun Error
</span><span class="z-text z-plain">0	Data Ready
</span></code></pre><ol start=7><li><p>调用write_mcr(0)写Modem控制寄存器以控制流量。</p><li><p>调用init初始化串口，参数是时钟和波特率。这里传入的时钟是100_000_000（单位是Hz？），波特率是之前传入的参数。</p><li><p>调用enable_received_data_available_interrupt()，使串口进入可以接收数据的状态</p><li><p>设置rx_intr_enabled为true，表明可以接收数据了。</p><li><p>调用write_fcr(0b11_000_11_1)，代码有注释：从最低位开始，分别代表：</p></ol><table><thead><tr><th><th><th><th><th><th><th><th><tbody><tr><td>1<td>1<td>0<td>0<td>0<td>1<td>1<td>1<tr><td>中断触发等级=14字节(Bytes)<td>触发等级=56字节<td>启用64字节FIFO(16750)<td>保留<td>DMA模式选择<td>FIFO清除(复位)发送<td>FIFO清除接收<td>启用FIFO</table><p>疑问： 最开始找到的是uart8250 crate 0.6版本的文档，接口有比较大的变化，后续有时间来看<h3 id=lkm-init><a aria-label="Anchor link for: lkm-init" class="header-anchor no-hover-padding" href=#lkm-init><span aria-hidden=true class=link-icon></span></a> lkm::init()</h3><p>通过lazy_static做了三件事：<ol><li>加载全局变量SHARED_SCHE，加载了名为<code>sharedscheduler</code>的应用程序，作为共享调度器。<li>为之创建了名为SHARED_SCHE_MEMORYSET的全局内存管理实例。<li>创建全局变量SHARED_ELF，保存从<code>sharedscheduler</code>的应用程序文件读取的elf数据。</ol></section><nav class=article-navigation><div><a aria-label="<<<" aria-describedby=left_title href=https://blog.windeye.top/oscamp/virtiogpu/><span class=arrow>←</span> <<<</a><p aria-hidden=true id=left_title>Virtio Gpu驱动移植</div><div><a aria-label=">>>" aria-describedby=right_title href=https://blog.windeye.top/oscamp/workingnote1/>>>> <span class=arrow>→</span></a><p aria-hidden=true id=right_title>2023秋冬季开源操作系统训练营日志（一）</div></nav><div class=comments data-category=Announcements data-category-id=DIC_kwDOK70hhM4Cb4Qn data-dark-theme=noborder_dark data-input-position=top data-lang=zh-Hans data-lazy-loading=true data-light-theme=noborder_light data-mapping=specific data-reactions-enabled=1 data-repo=ziyouwa/blog-commit data-repo-id=R_kgDOK70hhA data-strict=1 data-term=rcore-n-code id=comments><script async src=https://blog.windeye.top/js/giscus.min.js></script><noscript>You need JavaScript to view the comments.</noscript></div></article></main><div id=button-container><div id=toc-floating-container><input class=toggle id=toc-toggle type=checkbox><label class=overlay for=toc-toggle></label><label class=button for=toc-toggle id=toc-button title=切换目录><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="M414.82-193.094q-18.044 0-30.497-12.32-12.453-12.319-12.453-30.036t12.453-30.086q12.453-12.37 30.497-12.37h392.767q17.237 0 29.927 12.487 12.69 12.486 12.69 30.203 0 17.716-12.69 29.919t-29.927 12.203H414.82Zm0-244.833q-18.044 0-30.497-12.487Q371.87-462.9 371.87-480.45t12.453-29.92q12.453-12.369 30.497-12.369h392.767q17.237 0 29.927 12.511 12.69 12.512 12.69 29.845 0 17.716-12.69 30.086-12.69 12.37-29.927 12.37H414.82Zm0-245.167q-18.044 0-30.497-12.32t-12.453-30.037q0-17.716 12.453-30.086 12.453-12.369 30.497-12.369h392.767q17.237 0 29.927 12.486 12.69 12.487 12.69 30.203 0 17.717-12.69 29.92-12.69 12.203-29.927 12.203H414.82ZM189.379-156.681q-32.652 0-55.878-22.829t-23.226-55.731q0-32.549 23.15-55.647 23.151-23.097 55.95-23.097 32.799 0 55.313 23.484 22.515 23.484 22.515 56.246 0 32.212-22.861 54.893-22.861 22.681-54.963 22.681Zm0-245.167q-32.652 0-55.878-23.134-23.226-23.135-23.226-55.623 0-32.487 23.467-55.517t56.12-23.03q32.102 0 54.721 23.288 22.62 23.288 22.62 55.775 0 32.488-22.861 55.364-22.861 22.877-54.963 22.877Zm-.82-244.833q-32.224 0-55.254-23.288-23.03-23.289-23.03-55.623 0-32.333 23.271-55.364 23.272-23.03 55.495-23.03 32.224 0 55.193 23.288 22.969 23.289 22.969 55.622 0 32.334-23.21 55.364-23.21 23.031-55.434 23.031Z"/></svg></label><div class=toc-content><div class=toc-container><ul><li><a href=https://blog.windeye.top/oscamp/rcore-n-code/#huan-jing>环境</a><li><a href=https://blog.windeye.top/oscamp/rcore-n-code/#rust-main>rust_main</a> <ul><li><a href=https://blog.windeye.top/oscamp/rcore-n-code/#device-init>device::init()</a><li><a href=https://blog.windeye.top/oscamp/rcore-n-code/#plic>PLIC</a> <ul><li><a href=https://blog.windeye.top/oscamp/rcore-n-code/#plic-init>plic:init()</a><li><a href=https://blog.windeye.top/oscamp/rcore-n-code/#plic-init-hart-hart-id>plic::init_hart(hart_id);</a></ul><li><a href=https://blog.windeye.top/oscamp/rcore-n-code/#uart-init>uart:init()</a><li><a href=https://blog.windeye.top/oscamp/rcore-n-code/#lkm-init>lkm::init()</a></ul></ul></div></div></div><a class=no-hover-padding href=#comments id=comments-button title=转到评论区> <svg viewbox="0 0 20 20" fill=currentColor><path d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule=evenodd fill-rule=evenodd /></svg> </a><a class=no-hover-padding href=# id=top-button title=返回页面顶部> <svg viewbox="0 0 20 20" fill=currentColor><path d="M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z"/></svg> </a></div><span class=hidden id=copy-success> 已复制! </span><span class=hidden id=copy-init> 复制代码到剪贴板 </span><script defer src=https://blog.windeye.top/js/copyCodeToClipboard.min.js></script></div><footer><section><nav class="socials nav-navs"><ul><li><a class="nav-links no-hover-padding social" href=https://blog.windeye.top/atom.xml> <img alt=feed src=https://blog.windeye.top/social_icons/rss.svg title=feed> </a><li class=js><a class="nav-links no-hover-padding social" data-encoded-email="eWpzc3NAaG90bWFpbC5jb20=" href=#><img alt=email src=https://blog.windeye.top/social_icons/email.svg title=email> </a><li><a class="nav-links no-hover-padding social" rel=" me" href=https://github.com/ziyouwa/> <img alt=github src=https://blog.windeye.top/social_icons/github.svg title=github> </a></ul></nav><nav class=nav-navs><small> <ul><li><a class="nav-links no-hover-padding" href=https://blog.windeye.top/about/> 关于 </a><li><a class="nav-links no-hover-padding" href=https://blog.windeye.top/privacy/> 隐私政策 </a></ul> </small></nav><div class=credits><small> 网站基于 <a href=https://www.getzola.org>Zola</a> 和 <a href=https://github.com/welpo/tabi>tabi</a> </small></div></section><script async src=https://blog.windeye.top/js/decodeMail.min.js></script></footer>